
#필요한 툴 설치(Centos7)
yum install expat-devel
yum install gcc*


#####################
# PCRE 설치
#####################

1. 다운로드
mkdir -p /app/src
cd /app/src
wget http://sourceforge.net/projects/pcre/files/pcre/8.31/pcre-8.31.tar.gz
tar zxvf pcre-8.31.tar.gz
cd /app/src/pcre-8.31
./configure
make && make install

#####################
# APACHE 설치
#####################

### 소스파일 준비(httpd-2.4.33)
#apr과 apr-util은 apache src 하위 디렉토리로 옮긴다

1. apache 다운로드 후 압축풀기
mkdir -p /app/src
cd /app/src
wget http://apache.mirror.cdnetworks.com/httpd/httpd-2.4.34.tar.gz 
tar zxvf httpd-2.4.34.tar.gz

2. apr 다운로드 후 압출풀어서 아파치소스 디렉토리 밑에 옮김
cd /app/src
wget http://apache.mirror.cdnetworks.com/apr/apr-1.6.3.tar.gz
tar zxvf apr-1.6.3.tar.gz
mv apr-1.6.3 /app/src/httpd-2.4.34/srclib/apr
ll /app/src/httpd-2.4.34/srclib/

3. apr-util 다운로드 후 압출풀어서 아파치소스 디렉토리 밑에 옮김
cd /app/src
wget http://apache.mirror.cdnetworks.com/apr/apr-util-1.6.1.tar.gz 
tar zxvf apr-util-1.6.1.tar.gz
mv apr-util-1.6.1 /app/src/httpd-2.4.34/srclib/apr-util
ll /app/src/httpd-2.4.34/srclib/

4. apache 설치(OpenSSL manual update 후 설치)

cd /app/src/httpd-2.4.34

case. 표준설치 (OpenSSL 수동 업데이트 후 설치)
./configure --prefix=/app/apache24 --enable-modules=shared --enable-mods-shared=all --enable-pie --enable-ssl --with-ssl=/usr/local/ssl --enable-proxy --enable-proxy-balancer -enable-proxy-ajp -enable-proxy-http --enable-rewrite --enable-unique-id --enable-mpms-shared=all --with-included-apr

case. 통상적인 설치 옵션 및 절차
./configure --prefix=/app/apache24 --enable-proxy --enable-proxy-balancer --enable-proxy-ajp --enable-proxy-http --enable-rewrite --enable-ssl --enable-unique-id --enable-mods-shared=all --enable-modules=shared --enable-mpms-shared=all --with-included-apr

make && make install


#####################
# libtool 버전 일치
#####################

###먼저, libtool 버전 확인 후 일치되게 만듬

#OS libtool 버전 확인
whereis libtool
/usr/bin/libtool --version

#Apache libtool  버전 확인
/app/apache24/build/libtool --version

#버전 정보 차이가 있으면 다음 과정으로 진행 Apache libtool 백업(apache libtool 위치로 이동 후)
cd /app/apache24/build/
mv libtool libtool_org
chmod 644 libtool_org
ln -s /usr/bin/libtool /app/apache24/build/libtool


#####################
# mod_jk 설치
#####################

cd /app/src
wget http://10.10.63.63:8089/downloads/apache/tomcat-connectors-1.2.43-src_r20180306.tar.gz
tar zxvf tomcat-connectors-1.2.43-src_r20180306.tar.gz
cd /app/src/tomcat-connectors-1.2.43-src/native
./configure --with-apxs=/app/apache24/bin/apxs

make && make install

chmod 755 /app/apache24/modules/mod_jk.so
ll /app/apache24/modules


##########################################
# apache : 설정파일 백업
##########################################

cd /app/apache24/conf
bk httpd.conf

cd /app/apache24/conf/extra
bk httpd-mpm.conf
bk httpd-vhosts.conf
bk httpd-default.conf
bk httpd-ssl.conf

##########################################
# apache : httpd.conf 설정
##########################################

1. <Dicrectory> 태그 2개 영역을 지우거나 주석처리하고 그 자리에 붙여 넣기
vi /app/apache24/conf/httpd.conf
---------------------------------------------------------------------------------------------
### Global section
Include conf/extra/httpd-mpm.conf
Include conf/extra/httpd-vhosts.conf
Include conf/extra/httpd-default.conf
Include conf/extra/httpd-ssl.conf

### Main server configuration
ServerName localhost:80
ErrorLog "|/app/apache24/bin/rotatelogs logs/error.%y%m%d.log 86400 540"
CustomLog "|/app/apache24/bin/rotatelogs /logs/access.%y%m%d.log 86400 540" common
<Directory "/app/webapps">
    Options IncludesNoExec
    Order allow,deny
    Allow from all
    Require all granted
</Directory>
---------------------------------------------------------------------------------------------

2. mod_ssl 주석해제
vi /app/apache24/conf/httpd.conf
---------------------------------------------------------------------------------------------
LoadModule ssl_module modules/mod_ssl.so
---------------------------------------------------------------------------------------------


grep -v "#" /app/apache24/conf/httpd.conf



##########################################
# apache : httpd-vhosts.conf 설정(IP주소 수정)
##########################################
# 기존 파일을 아래 내용으로 대체

---------------------------------------------------------------------------------------------
cat << EOF > /app/apache24/conf/extra/httpd-vhosts.conf
<VirtualHost *:80>
    ServerAdmin webmaster@homeplus.co.kr
    DocumentRoot "/app/webapps"
    ServerName 10.10.64.90
    ServerAlias 10.10.64.90
    ErrorLog "|/app/apache24/bin/rotatelogs logs/error.%Y-%m-%d.log 86400 540"
    CustomLog "|/app/apache24/bin/rotatelogs logs/access.%Y-%m-%d.log 86400 540" combined
    LogLevel warn
</VirtualHost>
EOF
---------------------------------------------------------------------------------------------

*** awk로 로컬IP주소로 수정토록한다.

grep -v "#" /app/apache24/conf/extra/httpd-vhosts.conf

4. httpd-ssl.conf(IP주소수정일단 PASS)

grep -v "#" /app/apache24/conf/extra/httpd-ssl.conf

##########################################
# apache : httpd-ssl.conf 설정(IP주소 수정)
##########################################
#해당되는 인증서파일을 설정파일이 가리키는 위치에 복사
#아래 예제는 인증서 암호 포함됨
#인증서파일을 임시웹서버에서 wget으로 가져오나 mine설정으로 key파일을 zip확장으로 변경했음

1. ssl 인증서 담을 디렉토리 생성(root)
mkdir -p /app/apache24/conf/ssl

2. 인증서파일 생성(복사)
cd /app/apache24/conf/ssl
wget http://10.10.63.63:8089/downloads/cert/star.aafood.co.kr/Wildcard.aafood.co.kr.crt
wget http://10.10.63.63:8089/downloads/cert/star.aafood.co.kr/Wildcard.aafood.co.kr.key.zip
mv Wildcard.aafood.co.kr.key.zip Wildcard.aafood.co.kr.key

wget http://10.10.63.63:8089/downloads/cert/star.aafood.co.kr/GLOBALSIGN_ORGANIZATION_VALIDATION_CA__SHA256__G.crt
wget http://10.10.63.63:8089/downloads/cert/star.aafood.co.kr/GLOBALSIGN_ROOT_CA.crt
ll

3. httpd-ssl.conf파일은 아래 내용으로 새로 만듬(root)
vi /app/apache24/conf/extra/httpd-ssl.conf
#인증서 암호가 걸려있으면 "SSLPassPhraseDialog" 사용
---------------------------------------------------------------------------------------------
cat << EOF > /app/apache24/conf/extra/httpd-ssl.conf

#SSLPassPhraseDialog  builtin
#SSLPassPhraseDialog "/app/apache24/conf/ssl/ssl_pass.sh"  
#SSLSessionCache        "shmcb:/app/apache24/logs/ssl_scache(512000)"
#SSLSessionCacheTimeout  300

Listen 443       

<VirtualHost *:443>
    ServerName devaaf.aafood.co.kr
    DocumentRoot "/app/webapps"
    ErrorLog "|/app/apache24/bin/rotatelogs logs/ssl_error.%Y-%m-%d.log 86400 540"
    CustomLog "|/app/apache24/bin/rotatelogs logs/ssl_access.%Y-%m-%d.log 86400 540" combined
    LogLevel warn
    SSLEngine on
    SSLProxyEngine on
    SSLProtocol All -SSLv2 -SSLv3
    SSLCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES
    SSLProxyCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES
    SSLCertificateFile "/app/apache24/conf/ssl/Wildcard.aafood.co.kr.crt"
    SSLCertificateKeyFile "/app/apache24/conf/ssl/Wildcard.aafood.co.kr.key"
    SSLCertificateChainFile "/app/apache24/conf/ssl/GLOBALSIGN_ORGANIZATION_VALIDATION_CA__SHA256__G.crt"
    SSLCACertificateFile "/app/apache24/conf/ssl/GLOBALSIGN_ROOT_CA.crt"
</VirtualHost>
EOF
---------------------------------------------------------------------------------------------

clear
grep -v "#" /app/apache24/conf/extra/httpd-ssl.conf

4. 인증서암호 입력 쉘작성

vi /app/apache24/conf/ssl/ssl_pass.sh
---------------------------------------------------------------------------------------------
#!/bin/sh
echo "패스위드"
---------------------------------------------------------------------------------------------

chmod 700 ssl_pass.sh



##############################
# apache 구동스크립트 수정
##############################

mkdir -p /app/webapps

cd /app/apache24/bin
bk apachectl

vi /app/apache24/bin/apachectl
-------------------------------------------------------------------
#>>>>46번 줄에 추가(HTTPD 밑에 추가)
HTTPD='/app/apache24/bin/httpd'
# Source function library.        #add
. /etc/rc.d/init.d/functions      #add

#>>>>81번 줄에  "$HTTPD -k $ARGV" 줄을 지우고 아래 3개 줄 추가
case $ACMD in
start|stop|restart|graceful|graceful-stop)
    echo -n "$ARGV HTTPD : "      #add
    daemon $HTTPD -k $ARGV        #add
    echo                          #add
    ERROR=$?
    ;;
-------------------------------------------------------------------


/app/apache24/bin/apachectl start


#####################
# WWW ROOT에 파일넣기
#####################

cd /app/webapps
wget http://10.10.63.63:8089/downloads/testpages/hello.html
wget http://10.10.63.63:8089/downloads/testpages/index.html













